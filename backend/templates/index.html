<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Coachify Sales Training</title>
  <style>
    #conversation {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 20px;
    }
    .controls {
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div id="conversation"></div>
  <div class="controls">
    <button id="startButton">Start Conversation</button>
    <button id="stopButton" disabled>Stop</button>
  </div>

  <script>
    let recognition;
    let ws;
    let synth = window.speechSynthesis;
    let isRecording = false;
    let currentUtterance = null;

    // Initialize voices and set preferred voice
    let preferredVoice = null;
    function loadVoices() {
      const voices = synth.getVoices();
      // Try to find a female English voice
      preferredVoice = voices.find(voice => 
        voice.name.includes('Female') && voice.lang.startsWith('en-')
      ) || voices[0];
      console.log('Selected voice:', preferredVoice?.name);
    }

    // Load voices when they're available
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }

    function speakText(text) {
      // Cancel any ongoing speech
      synth.cancel();

      // Create new utterance
      const utterance = new SpeechSynthesisUtterance(text);
      
      // Configure utterance
      utterance.voice = preferredVoice;
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;

      // Handle utterance events
      utterance.onend = () => {
        console.log('Finished speaking');
        currentUtterance = null;
      };

      utterance.onerror = (event) => {
        console.error('Speech error:', event);
        currentUtterance = null;
      };

      // Store current utterance
      currentUtterance = utterance;

      // Start speaking
      synth.speak(utterance);
    }

    async function startRecording() {
      try {
        // Initialize Web Speech API
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = false;
        
        // Connect to WebSocket
        ws = new WebSocket('ws://localhost:8000/ws/voice');

        // Handle speech recognition results
        recognition.onresult = async (event) => {
          const transcript = event.results[event.results.length - 1][0].transcript;
          if (ws.readyState === WebSocket.OPEN) {
            // Send transcript to server
            ws.send(new TextEncoder().encode(transcript));
          }
        };

        // Handle WebSocket messages
        ws.onmessage = async (event) => {
          const response = JSON.parse(event.data);
          updateConversation(response);

          // Speak the response using the enhanced speech function
          if (response.response_text) {
            speakText(response.response_text);
          }
        };

        // Start recognition
        recognition.start();
        isRecording = true;
        
        // Update UI
        document.getElementById('startButton').disabled = true;
        document.getElementById('stopButton').disabled = false;
      } catch (error) {
        console.error('Error starting recording:', error);
        alert('Error accessing microphone. Please ensure microphone permissions are granted.');
      }
    }

    function stopRecording() {
      if (recognition && isRecording) {
        recognition.stop();
        isRecording = false;
        ws.close();
        
        // Stop any ongoing speech
        if (currentUtterance) {
          synth.cancel();
          currentUtterance = null;
        }
        
        document.getElementById('startButton').disabled = false;
        document.getElementById('stopButton').disabled = true;
      }
    }

    function updateConversation(response) {
      const conversationDiv = document.getElementById('conversation');
      conversationDiv.innerHTML += `
        <p><strong>You:</strong> ${response.transcription || 'Processing...'}</p>
        <p><strong>Agent:</strong> ${response.response_text || ''}</p>
        <p><em>Feedback:</em> ${response.feedback || ''}</p>
      `;
      conversationDiv.scrollTop = conversationDiv.scrollHeight;
    }

    // Event listeners
    document.getElementById('startButton').onclick = startRecording;
    document.getElementById('stopButton').onclick = stopRecording;

    // Load voices immediately in case they're already available
    loadVoices();
  </script>
</body>
</html>
